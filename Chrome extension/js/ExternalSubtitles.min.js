function initExternalSubtitlesSupport(){$("#search-opensubtitles-heading").html("<a href='http://www.opensubtitles.org/en/search' target='_blank'>"+"<img src='"+chrome.extension.getURL("images/opensubtitles_128.png")+"' />"+"</a><br><br>"+"<a href='http://amara.org/en/' target='_blank'>"+"<img width='128px' src='"+chrome.extension.getURL("images/amara.png")+"' />"+"</a>");$("#subtitles-tag").val(tag);}
function loadNewSubs(){if(!tag){$("#subtitles-dialog-error").html("Please enter a title");console.log("Tag not found in loadNewSubs. So returning");return;}
var amaraSubLanguage=$('#sub-language').find('option:selected').attr('amaraSubLanguage');var openSubtitleSubLanguage=$('#sub-language').val();$("#subtitles-tag").val(tag);console.log("Searching subs for tag: "+tag+" with lang: "+openSubtitleSubLanguage+" "+amaraSubLanguage);$("#search-con .empty-con").css('display','none');$("#sub-files").css('display','none');$("#search-con .loader").css('display','block');$("#subtitles-dialog-error").html("Searching subs for "+tag);chrome.runtime.sendMessage({action:"loadNewSubs",openSubtitleSubLanguage:openSubtitleSubLanguage,amaraSubLanguage:amaraSubLanguage,tag:tag,youtubeUrl:window.location.href,originalTag:$("#eow-title").html()},function(response){response=response.response;console.log("Response for loadNewSubs here is: ");console.log(response);if(response&&response.subtitles){$("#search-con .empty-con").css('display','none');$("#subtitles-dialog-error").html("Please select the subtitle from the dropdown to apply.");$("#sub-files").css('display','block');$(".loader").css('display','none');$("#sub-files").html('<option value="none">None</option>');var firstValue="";$.each(response.subtitles,function(index,value){var source=value["source"];if(value["source"]=="OpenSubtitles"){source="OpenSub";}
$("#sub-files").append($("<option></option>").attr("value",value["downloadUrl"]).attr("encoding",value["encoding"]).text("["+source+"]  "+value["name"]));if(!firstValue){firstValue=value["downloadUrl"];}});if(autoLoad&&firstValue){$("#sub-files").val(firstValue).change();}}else{$("#subtitles-dialog-error").html("");$("#sub-files").html('<option value="none">None</option>');$(".loader").css('display','none');$("#search-con .empty-con").css('display','block');$("#search-con .empty-con").html("<img src='"+chrome.extension.getURL("images/empty.svg")+"' />");}});}
var registerEvents=function(){$("#sub-open-search-btn").click(function(){loadNewSubs();$("#sub-open-subtitles").css("display","block");$("#subtitles-dialog-box").slideToggle('fast');$("#sub-open-search-btn").css("display","none");});$("#subtitle-button").click(function(){$('#watch-action-panels').css("display","none");$('#new-subtitles-con').css("display","block");$("#search-button").click();})
$('.action-panel-trigger').click(function(){$('#new-subtitles-con').css("display","none");})
$("#subtitle-close").click(function(){$('#new-subtitles-con').css("display","none");})
$('#search-con .search-subtitles').click(function(){loadNewSubs();});$("#search-button").click(function(){loadNewSubs();$('#search-con').css("display","block");$('#upload-con').css("display","none");$('#settings-con').css("display","none");$("#subtitles-dialog-box").css("display","block");})
$("#upload-button").click(function(){$('#search-con').css("display","none");$('#upload-con').css("display","block");$('#settings-con').css("display","none");$("#subtitles-dialog-box").css("display","none");})
$("#settings-button").click(function(){$('#search-con').css("display","none");$('#upload-con').css("display","none");$('#settings-con').css("display","block");$("#subtitles-dialog-box").css("display","none");})
$('#subtitles-auto-load').change(function(){autoLoad=$("#subtitles-auto-load").prop('checked');storeAutoLoadFlag(autoLoad);});$("#subtitles-tag").on('change',function(){console.log("Subtitle tag is:"+this.value);tag=this.value;loadNewSubs();});$('#sub-language').on('change',function(){console.log("Language code selected is:"+this.value);subLanguage=this.value;loadNewSubs();chrome.storage.local.set({"sublanguageid":subLanguage},function(){console.log("Stored language id: "+subLanguage+" in chrome storage");});});$("#sub-files").on('change',function(){var subDownloadLink=this.value;console.log("YOYOY: "+subDownloadLink);if(subDownloadLink=="none"){console.log("Hiding subtitles");subBubblesVideo.subsShow(false);areSubtitlesShowing=false;$("#sub-info").html("Subtitles disabled").fadeIn();fadeOutSubtitlesInfo();return;}
var encoding=$('option:selected',this).attr('encoding');console.log("ENCODING FOUND HERE: "+encoding);var updatedUrl="";if(subDownloadLink&&subDownloadLink.indexOf("blob")>-1){console.log("Found local url: "+subDownloadLink);if(!encoding){encoding="UTF-8";}
loadSubtitles(subDownloadLink,false,encoding);}else{console.log("Sub download link is : "+subDownloadLink);var encodedURL=encodeURIComponent(subDownloadLink);console.log("Encode URI Component: "+encodedURL);updatedUrl="https://subtitles-youtube.herokuapp.com/Upload/uploadGZipFile?url="+encodedURL;loadSubtitles(updatedUrl,false,encoding);}});};